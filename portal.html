<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDM Health System</title>
    <link rel="icon" type="image/x-icon" href="favicon cdm.ico">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-image: url('portalbg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh; 
            padding: 20px; 
}
        .container { max-width: 1400px; margin: 0 auto; }
        .header { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            margin-bottom: 30px; 
        }
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 20px;
            margin-bottom: 25px; /* Add this line for spacing */
}
        .header-title { display: flex; align-items: center; gap: 15px; }
        .header-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: none; /* REMOVE GRADIENT */
        }   

        .header-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Makes the icon fit nicely */
        }

        .readonly-notice {
    background: #dbeafe;
    border: 1px solid #3b82f6;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 20px;
    color: #1e40af;
    font-size: 14px;
}

        h1 { color: #333; font-size: 28px; margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 14px; }

        .nav-buttons { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
}
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 14px; }
        .btn-primary { background: #63c5da 100%; color: white; }
        .btn-primary:hover { background: #6b7ee9; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .btn-success { background: #0284c7; color: white; }
        .btn-success:hover { background: #0284c7; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-danger { background: #ef4444; color: white; padding: 8px 16px; font-size: 13px; }
        .btn-edit { background: #667eea; color: white; padding: 8px 16px; font-size: 13px; }
        .content-box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        h2 { color: #333; font-size: 24px; }
        .patient-count { background: #f3f4f6; padding: 8px 16px; border-radius: 8px; color: #667eea; font-weight: 600; font-size: 14px; }
        .search-box {
    display: flex;
    gap: 10px;
    align-items: center;
    flex: 1;
    max-width: 400px;
}

.search-box input {
    flex: 1;
    padding: 10px 15px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
}

.search-box input:focus {
    outline: none;
    border-color: #667eea;
}
        .patient-list, .schedule-grid, .inventory-grid, .services-grid { display: flex; flex-direction: column; gap: 20px; }
        .patient-card, .schedule-card, .inventory-item, .service-card { border: 2px solid #e5e7eb; border-radius: 12px; padding: 25px; transition: all 0.3s; }
        .patient-card:hover, .inventory-item:hover, .service-card:hover { box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .schedule-card { background: linear-gradient(135deg, #0284c7 100%, #764ba2 0%); color: white; border: none; }
        .patient-header, .inventory-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; }
        .patient-name, .inventory-name, .service-name { font-size: 20px; font-weight: 700; color: #333; margin-bottom: 5px; }
        .schedule-card h3 { font-size: 18px; margin-bottom: 10px; color: white; }
        .patient-id { color: #9ca3af; font-size: 13px; margin-bottom: 15px; }
        .patient-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-top: 15px; }
        .detail-item { display: flex; align-items: center; gap: 8px; color: #6b7280; font-size: 14px; }
        .detail-icon { color: #667eea; font-weight: bold; }
        .allergy-warning { background: #fee2e2; border: 1px solid #fca5a5; border-radius: 8px; padding: 12px; margin-top: 15px; color: #991b1b; font-size: 14px; }
        .patient-actions {
            display: flex;
            gap: 10px;
            z-index: 10;
            position: relative;
}
        .patient-actions button {
            pointer-events: auto;
            z-index: 10;
}
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: 1 / -1; }
        label { color: #374151; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .required { color: #ef4444; }
        input, select, textarea { padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.3s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        textarea { resize: vertical; min-height: 100px; }
        .form-actions { display: flex; gap: 15px; margin-top: 30px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
        .empty-icon { font-size: 64px; margin-bottom: 20px; }
        .empty-message { font-size: 18px; margin-bottom: 10px; }
        .hidden { display: none; }
        .low-stock { border-color: #fbbf24 !important; background: #fef3c7; }
        .low-stock-badge { background: #fbbf24; color: #78350f; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; margin-right: 10px; }
        .service-card { border-left: 4px solid #667eea; }
        .service-description { color: #6b7280; margin: 10px 0; }
        .service-hours { color: #667eea; font-weight: 600; font-size: 14px; }
        .quantity-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.quantity-btn {
    width: 35px;
    height: 35px;
    border: none;
    border-radius: 8px;
    background: #667eea;
    color: white;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.quantity-btn:hover {
    background: #5568d3;
    transform: scale(1.1);
}

.quantity-display {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    min-width: 80px;
    text-align: center;
}
.visit-record {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
    background: #f9fafb;
}

.visit-date {
    font-weight: 600;
    color: #667eea;
    margin-bottom: 5px;
}

.visit-note {
    color: #6b7280;
    margin: 5px 0;
}

.visit-revisit {
    color: #059669;
    font-weight: 600;
    margin-top: 5px;
}
.visit-log-container {
    margin-top: 15px;
    border-top: 2px solid #e5e7eb;
    padding-top: 15px;
}

.visit-log-header {
    font-weight: 600;
    color: #374151;
    margin-bottom: 10px;
    font-size: 16px;
}

.visit-entry {
    background: #f3f4f6;
    border-left: 4px solid #667eea;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 6px;
}

.visit-entry.revisit {
    border-left-color: #059669;
}

.visit-entry.emergency {
    border-left-color: #ef4444;
}

.visit-entry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.visit-type-badge {
    background: #667eea;
    color: white;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
}

.visit-type-badge.revisit {
    background: #059669;
}

.visit-type-badge.emergency {
    background: #ef4444;
}

.visit-timestamp {
    color: #6b7280;
    font-size: 13px;
}

.visit-complaint {
    font-weight: 600;
    color: #374151;
    margin-bottom: 5px;
}

.scheduled-revisit {
    background: #d1fae5;
    border: 1px solid #059669;
    border-radius: 6px;
    padding: 8px;
    margin-top: 8px;
    color: #065f46;
    font-size: 13px;
}

.no-visits {
    color: #9ca3af;
    font-style: italic;
    padding: 10px;
}
        .login-container {
    max-width: 500px;
    width: 90%;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 50px 40px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.login-form input {
    padding: 15px;
    font-size: 16px;
}

.login-form .btn {
    padding: 15px 24px;
    font-size: 16px;
}

.login-header h1 {
    font-size: 32px;
}

.login-header .subtitle {
    font-size: 16px;
}

.login-header {
    text-align: center;
    margin-bottom: 30px;
}
.login-header h1 {
    color: #0284c7;
    margin-bottom: 10px;
}
.login-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}
.toggle-login {
    text-align: center;
    margin-top: 20px;
    color: #0284c7;
    cursor: pointer;
    font-size: 14px;
}
.toggle-login:hover {
    text-decoration: underline;
}
.user-info {
    background: #f3f4f6;
    padding: 12px 24px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    min-width: 250px;
}

.user-info span {
    font-weight: 600;
    color: #374151;
    white-space: nowrap;
}
.btn-logout {
    background: #ef4444;
    color: white;
    padding: 10px 20px;
    font-size: 14px;
    white-space: nowrap;
}

.btn-logout:hover {
    background: #dc2626;
    transform: translateY(-1px);
}

.btn-logout:hover {
    background: #dc2626;
    transform: translateY(-1px);
}
.nurse-status {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 10px;
}

.status-available {
    background: #d1fae5;
    color: #065f46;
}

.status-break {
    background: #fef3c7;
    color: #78350f;
}

.status-leave {
    background: #fee2e2;
    color: #991b1b;
}

.status-controls {
    margin-top: 10px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.status-btn {
    padding: 6px 12px;
    font-size: 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
}

.status-btn.available {
    background: #059669;
    color: white;
}

.status-btn.break {
    background: #f59e0b;
    color: white;
}

.status-btn.leave {
    background: #dc2626;
    color: white;
}

.status-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
    </style>
</head>
<body>
    <div id="loginView" class="login-container">
    <div class="login-header">
        <div class="header-icon" style="margin: 0 auto 15px;">
            <img src="favicon cdm.ico" alt="CDM Icon">
        </div>
        <h1>CDM Health System</h1>
        <p class="subtitle" id="loginTypeLabel">User Login</p>
    </div>
    <div class="login-form">
        <div class="form-group">
            <label>Username <span class="required">*</span></label>
            <input type="text" id="loginUsername" required>
        </div>
        <div class="form-group">
            <label>Password <span class="required">*</span></label>
            <input type="password" id="loginPassword" required>
        </div>
        <button class="btn btn-primary" onclick="handleLogin()">Login</button>
        <div class="toggle-login" onclick="toggleLoginType()">
            <span id="toggleText">Switch to Admin Login</span>
        </div>
    </div>
</div>
    <div class="container">
        <div class="header">
    <div class="header-content">
        <div class="header-title">
            <div class="header-icon">
                <img src="favicon cdm.ico" alt="CDM Icon">
            </div>
            <div>
                <h1>Colegio de Muntinlupa</h1>
                <p class="subtitle">Health Management System</p>
            </div>
        </div>
        
        <div class="user-info" id="userInfo" style="display: none;">
            <span id="currentUserName"></span>
            <button class="btn btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>
    
    <div class="nav-buttons">
        <button class="btn btn-primary" id="patientsBtn" onclick="showView('list')" style="display: none;">üë• Patients</button>
        <button class="btn btn-primary" id="myInfoBtn" onclick="showView('myinfo')" style="display: none;">üë§ My Info</button>
        <button class="btn btn-primary" onclick="showView('schedule')">üìÖ Nurse Schedule</button>
        <button class="btn btn-primary" onclick="showView('inventory')">üíä Inventory</button>
        <button class="btn btn-primary" onclick="showView('services')">üè• Services</button>
        <button class="btn btn-primary" id="userMgmtBtn" onclick="showView('users')" style="display: none;">üë§ Users</button>
        <button class="btn btn-primary" id="visitsBtn" onclick="showView('visits')" style="display: none;">üìã Visits</button>
    </div>
</div>

        <div id="listView" class="content-box">
    <div class="section-header">
        <h2>Patient Directory</h2>
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <div class="search-box">
                <input type="text" id="patientSearch" placeholder="üîç Search by name..." onkeyup="searchPatients()">
            </div>
            <div class="patient-count">Total: <span id="patientCount">0</span></div>
            <button class="btn btn-success" onclick="clearFormAndShow()">‚ûï New</button>
        </div>
    </div>
    <div id="patientList" class="patient-list"></div>
    <div id="emptyState" class="empty-state hidden">
        <div class="empty-icon">üë•</div>
        <p class="empty-message">No patients registered</p>
    </div>
</div>

        <div id="formView" class="content-box hidden">
            <h2 id="formTitle">üìã Register New Patient</h2>
            <div class="form-grid" style="margin-top: 25px;">
                <div class="form-group">
                    <label>Student Number <span class="required">*</span></label>
                    <input type="text" id="studentNumber" placeholder="e.g., 2024-12345" required>
            </div>
            
                <div class="form-group">
                    <label>First Name <span class="required">*</span></label>
                    <input type="text" id="firstName" required>
                </div>

                <div class="form-group">
                    <label>Last Name <span class="required">*</span></label>
                    <input type="text" id="lastName" required>
                </div>

                <div class="form-group">
                    <label>Middle Initial <span class="required">*</span></label>
                    <input type="text" id="middleInitial" required>
                </div>

                <div class="form-group">
                    <label>Suffix <span class="required">*</span></label>
                    <input type="text" id="suffix" required>
                </div>

                <div class="form-group">
                    <label>Date of Birth <span class="required">*</span></label>
                    <input type="date" id="dateOfBirth" required>
                </div>

                <div class="form-group">
                    <label>Gender <span class="required">*</span></label>
                    <select id="gender" required>
                        <option value="">Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Blood Type <span class="required">*</span></label>
                    <select id="bloodType" required>
                        <option value="">Select</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="Unknown">Unknown</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Phone <span class="required">*</span></label>
                    <input type="tel" id="phone" required>
                </div>
                <div class="form-group full-width">
                    <label for="allergies">Allergies <span class="required">*</span></label>
                    <input type="text" id="allergies" placeholder="None or list" required>
                </div>
                <div class="form-group full-width">
                    <label>Address <span class="required">*</span></label>
                    <input type="text" id="address" required>
                </div>
                <div class="form-group">
                    <label>Email <span class="required">*</span></label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group full-width">
                    <label>Emergency Contact <span class="required">*</span></label>
                    <input type="text" id="emergencyContact" required>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="savePatient()">Save</button>
                <button class="btn btn-secondary" onclick="showView('list')">Cancel</button>
            </div>
        </div>

        <div id="scheduleView" class="content-box hidden">
            <div class="section-header">
             <h2>üìÖ Nurse Schedule Availability </h2>
                <button class="btn btn-success admin-only" onclick="showScheduleForm()">‚ûï Add</button>
            </div>
            <div id="scheduleList" class="schedule-grid"></div>
            </div>

        <div id="scheduleFormView" class="content-box hidden">
            <h2>üìã Add Schedule</h2>
            <div class="form-grid" style="margin-top: 25px;">
                <div class="form-group">
                    <label>Nurse Name <span class="required">*</span></label>
                    <input type="text" id="nurseName" required>
                </div>
                <div class="form-group">
                    <label>Day <span class="required">*</span></label>
                    <select id="scheduleDay" required>
                        <option value="">Select</option>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label>Time <span class="required">*</span></label>
                    <input type="text" id="scheduleTime" placeholder="8:00 AM - 5:00 PM" required>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveSchedule()">Save</button>
                <button class="btn btn-secondary" onclick="showView('schedule')">Cancel</button>
            </div>
        </div>

        <div id="inventoryView" class="content-box hidden">
            <div class="section-header">
                <h2>üíä Medication Inventory</h2>
                    <button class="btn btn-success admin-only" onclick="showInventoryForm()">‚ûï Add</button>
            </div>
            <div id="inventoryList" class="inventory-grid"></div>
            </div>

        <div id="inventoryFormView" class="content-box hidden">
            <h2>üìã Add Medication</h2>
            <div class="form-grid" style="margin-top: 25px;">
                <div class="form-group">
                    <label>Name <span class="required">*</span></label>
                    <input type="text" id="medName" required>
                </div>
                <div class="form-group">
                    <label>Quantity <span class="required">*</span></label>
                    <input type="number" id="medQuantity" required>
                </div>
                <div class="form-group">
                    <label>Unit <span class="required">*</span></label>
                    <input type="text" id="medUnit" placeholder="tablets, bottles" required>
                </div>
                <div class="form-group">
                    <label>Expiry <span class="required">*</span></label>
                    <input type="date" id="medExpiry" required>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveMedication()">Save</button>
                <button class="btn btn-secondary" onclick="showView('inventory')">Cancel</button>
            </div>
        </div>
        <div id="userManagementView" class="content-box hidden">
    <div class="section-header">
        <h2>üë• User Accounts</h2>
    </div>
    <div id="usersList" class="patient-list"></div>
</div>



        <div id="servicesView" class="content-box hidden">
            <div class="section-header">
            <h2>üè• Clinic Services</h2>
            <button class="btn btn-success admin-only" onclick="showServiceForm()">‚ûï Add</button>
            </div>
            <div id="servicesList" class="services-grid"></div>
            </div>

        <div id="myInfoView" class="content-box hidden">
    <div class="section-header">
        <h2>üë§ My Health Information</h2>
    </div>
    
    <div class="readonly-notice">
        ‚ÑπÔ∏è This is your registered health information. Contact the clinic admin to update any details.
    </div>
    
    <div id="myInfoContent">
        <!-- User info will be displayed here -->
    </div>
</div>
<div id="changePasswordView" class="content-box hidden">
    <h2>üîí Change Password</h2>
    <div class="form-grid" style="margin-top: 25px; max-width: 600px;">
        <div class="form-group full-width">
            <label>Current Password <span class="required">*</span></label>
            <input type="password" id="currentPassword" required>
        </div>
        <div class="form-group full-width">
            <label>New Password <span class="required">*</span></label>
            <input type="password" id="newPassword" required>
        </div>
        <div class="form-group full-width">
            <label>Confirm New Password <span class="required">*</span></label>
            <input type="password" id="confirmPassword" required>
        </div>
    </div>
    <div class="form-actions">
        <button class="btn btn-primary" onclick="saveNewPassword()">üíæ Update Password</button>
        <button class="btn btn-secondary" onclick="showView('myinfo')">Cancel</button>
    </div>
</div>
<div id="visitsView" class="content-box hidden">
    <div class="section-header">
        <h2>üìã Patient Visits</h2>
        <button class="btn btn-success" onclick="showVisitForm()">‚ûï New Visit</button>
    </div>
    <div id="visitsList" class="patient-list"></div>
</div>

<div id="visitsView" class="content-box hidden">
    <div class="section-header">
        <h2>üìã Patient Visit History</h2>
        <button class="btn btn-success" onclick="showVisitForm()">‚ûï Record Visit</button>
    </div>
    
    <div style="margin-bottom: 20px;">
        <div class="search-box">
            <select id="visitPatientFilter" onchange="filterVisitsByPatient()" style="padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="">All Patients</option>
            </select>
        </div>
    </div>
    
    <div id="visitsList" class="patient-list"></div>
</div>

<div id="visitFormView" class="content-box hidden">
    <h2>üìã Record Visit</h2>
    <div class="form-grid" style="margin-top: 25px;">
        <div class="form-group full-width">
            <label>Patient <span class="required">*</span></label>
            <select id="visitPatientId" required>
                <option value="">Select Patient</option>
            </select>
        </div>
        <div class="form-group">
            <label>Visit Type <span class="required">*</span></label>
            <select id="visitType" required>
                <option value="New Visit">New Visit</option>
                <option value="Revisit">Revisit</option>
                <option value="Follow-up">Follow-up</option>
                <option value="Emergency">Emergency</option>
            </select>
        </div>
        <div class="form-group">
            <label>Date & Time <span class="required">*</span></label>
            <input type="datetime-local" id="visitDateTime" required>
        </div>
        <div class="form-group full-width">
            <label>Chief Complaint <span class="required">*</span></label>
            <input type="text" id="visitComplaint" placeholder="e.g., Headache, Fever, Injury" required>
        </div>
        <div class="form-group full-width">
            <label>Notes / Treatment <span class="required">*</span></label>
            <textarea id="visitNotes" placeholder="Symptoms, diagnosis, treatment given, recommendations..." required></textarea>
        </div>
        <div class="form-group">
            <label>Schedule Revisit?</label>
            <input type="date" id="visitRevisitDate">
        </div>
        <div class="form-group full-width">
            <label>Revisit Reason</label>
            <input type="text" id="visitRevisitReason" placeholder="e.g., Follow-up checkup, medication refill">
        </div>
    </div>
    <div class="form-actions">
        <button class="btn btn-primary" onclick="saveVisit()">üíæ Save Visit</button>
        <button class="btn btn-secondary" onclick="showView('visits')">Cancel</button>
    </div>
</div>
        <div id="serviceFormView" class="content-box hidden">
            <h2>üìã Add Service</h2>
            <div class="form-grid" style="margin-top: 25px;">
                <div class="form-group full-width">
                    <label>Name <span class="required">*</span></label>
                    <input type="text" id="serviceName" required>
                </div>
                <div class="form-group full-width">
                    <label>Description <span class="required">*</span></label>
                    <textarea id="serviceDescription" required></textarea>
                </div>
                <div class="form-group full-width">
                    <label>Hours <span class="required">*</span></label>
                    <input type="text" id="serviceHours" placeholder="Mon-Fri, 8AM-5PM" required>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="saveService()"> Save</button>
                <button class="btn btn-secondary" onclick="showView('services')">Cancel</button>
            </div>
        </div>
    </div>

    
    <script>
    let data = {patients: [], schedules: [], medications: [], services: [], users: [], visits: []};
    let editing = {patient: null, schedule: null, medication: null, service: null};
    let db;

    // IndexedDB Setup
    async function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('CDMHealthSystem', 1);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                db = request.result;
                resolve(db);
            };
            
            request.onupgradeneeded = (event) => {
    const db = event.target.result;
    
    // Create object stores if they don't exist
    if (!db.objectStoreNames.contains('patients')) {
        const patientStore = db.createObjectStore('patients', { keyPath: 'id', autoIncrement: true });
        patientStore.createIndex('lastName', 'lastName', { unique: false });
        patientStore.createIndex('email', 'email', { unique: false });
    }
    
    if (!db.objectStoreNames.contains('schedules')) {
        const scheduleStore = db.createObjectStore('schedules', { keyPath: 'id', autoIncrement: true });
        scheduleStore.createIndex('day', 'day', { unique: false });
    }
    
    if (!db.objectStoreNames.contains('medications')) {
        const medStore = db.createObjectStore('medications', { keyPath: 'id', autoIncrement: true });
        medStore.createIndex('name', 'name', { unique: false });
    }
    
    if (!db.objectStoreNames.contains('services')) {
        db.createObjectStore('services', { keyPath: 'id', autoIncrement: true });
    }
    
    if (!db.objectStoreNames.contains('users')) {
        const userStore = db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
        userStore.createIndex('username', 'username', { unique: false });
        userStore.createIndex('patientId', 'patientId', { unique: false });
    }
    
    // ADD THIS - Visits store
    if (!db.objectStoreNames.contains('visits')) {
        const visitStore = db.createObjectStore('visits', { keyPath: 'id', autoIncrement: true });
        visitStore.createIndex('patientId', 'patientId', { unique: false });
        visitStore.createIndex('dateTime', 'dateTime', { unique: false });
    }
};
        });
    }

    // Generic IndexedDB functions
    async function getAllFromStore(storeName) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.getAll();
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function addToStore(storeName, data) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.add(data);
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function updateInStore(storeName, data) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.put(data);
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function deleteFromStore(storeName, id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.delete(id);
            
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }

    async function init() {
        await initDB();
        await loadData();
        renderPatients();
    }

   async function loadData() {
    try {
        data.patients = await getAllFromStore('patients');
        data.schedules = await getAllFromStore('schedules');
        data.medications = await getAllFromStore('medications');
        data.services = await getAllFromStore('services');
        data.users = await getAllFromStore('users');
        data.visits = await getAllFromStore('visits'); // ADD THIS LINE
        
        // Initialize with default data if empty
        if (data.schedules.length === 0) await initSchedules();
        if (data.medications.length === 0) await initMedications();
        if (data.services.length === 0) await initServices();
    } catch(e) {
        console.error('Error loading data:', e);
    }
}

    async function initSchedules() {
    const schedules = [
        {nurse:'Nurse Name',day:'Monday',time:'9:00 AM - 6:00 PM', status: 'Available'},
        {nurse:'Nurse Name',day:'Tuesday', time:'9:00 AM - 6:00 PM', status: 'Available'},
        {nurse:'Nurse Name',day:'Wednesday',time:'9:00 AM - 6:00 PM', status: 'Available'},
        {nurse:'Nurse Name',day:'Thursday',time:'9:00 AM - 6:00 PM', status: 'Available'},
        {nurse:'Nurse Name',day:'Friday',time:'9:00 AM - 6:00 PM', status: 'Available'},
    ];
    for (const schedule of schedules) {
        await addToStore('schedules', schedule);
    }
    data.schedules = await getAllFromStore('schedules');
}

    async function initMedications() {
        const medications = [
            {name:'Paracetamol',quantity:100,unit:'tablets',expiry:'2026-12-31'},
            {name:'Ibuprofen',quantity:50,unit:'tablets',expiry:'2026-06-30'},
            {name:'Antibiotic Ointment',quantity:15,unit:'tubes',expiry:'2025-12-31'},
            {name:'Bandages',quantity:200,unit:'pieces',expiry:'2027-01-31'},
            {name:'Alcohol',quantity:8,unit:'bottles',expiry:'2026-03-31'}
        ];
        for (const medication of medications) {
            await addToStore('medications', medication);
        }
        data.medications = await getAllFromStore('medications');
    }

    async function initServices() {
        const services = [
            {name:'Emergency Care',description:'Basic health check-up and consultation',hours:'Mon-Fri, 9AM-6PM'},
            {name:'Health Monitoring',description:'Immediate treatment for minor injuries',hours:'Mon-Fri, 9AM-6PM'},
            {name:'Administrative and Coordination',description:'Regular health screenings',hours:'Mon-Fri, 9AM-6PM'},
        ];
        for (const service of services) {
            await addToStore('services', service);
        }
        data.services = await getAllFromStore('services');
    }

   function showView(view) {
    // Check permissions for admin-only views
    if (currentUser && currentUser.type !== 'admin') {
        if (view === 'list' || view === 'register' || view === 'users') {
            alert('Access denied. Admin only.');
            return;
        }
    }
    
    document.querySelectorAll('.content-box').forEach(b => b.classList.add('hidden'));
    if (view === 'list') {
        document.getElementById('listView').classList.remove('hidden');
        renderPatients();
    } else if (view === 'register') {
        document.getElementById('formView').classList.remove('hidden');
    } else if (view === 'schedule') {
        document.getElementById('scheduleView').classList.remove('hidden');
        renderSchedules();
    } else if (view === 'inventory') {
        document.getElementById('inventoryView').classList.remove('hidden');
        renderInventory();
    } else if (view === 'services') {
        document.getElementById('servicesView').classList.remove('hidden');
        renderServices();
    } else if (view === 'users') {
        document.getElementById('userManagementView').classList.remove('hidden');
        renderUsers();
    } else if (view === 'myinfo') {
        document.getElementById('myInfoView').classList.remove('hidden');
        getAllFromStore('visits').then(visits => {
            data.visits = visits;
            renderMyInfo();
        });
    } else if (view === 'changepassword') {
        document.getElementById('changePasswordView').classList.remove('hidden');
        // Clear password fields
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
    } else if (view === 'visits') {
        document.getElementById('visitsView').classList.remove('hidden');
        renderVisits();
    }
}

    function renderPatients() {
    const list = document.getElementById('patientList');
    const empty = document.getElementById('emptyState');
    const count = document.getElementById('patientCount');
    count.textContent = data.patients.length;
    if (data.patients.length === 0) {
        list.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }
    empty.classList.add('hidden');
    
    list.innerHTML = data.patients.map(p => `
        <div class="patient-card">
            <div class="patient-name">${p.firstName} ${p.lastName}</div>
            <div class="patient-id">ID: ${p.id} | Student #: ${p.studentNumber || 'N/A'}</div>
            <div class="patient-details">
                <div class="detail-item"><span class="detail-icon">üìÖ</span><span>${p.dateOfBirth}</span></div>
                <div class="detail-item"><span class="detail-icon">üë§</span><span>${p.gender}</span></div>
                <div class="detail-item"><span class="detail-icon">ü©∏</span><span>${p.bloodType}</span></div>
                <div class="detail-item"><span class="detail-icon">üìû</span><span>${p.phone}</span></div>
                <div class="detail-item"><span class="detail-icon">‚úâÔ∏è</span><span>${p.email}</span></div>
                <div class="detail-item"><span class="detail-icon">üìç</span><span>${p.address}</span></div>
            </div>
            ${p.allergies && p.allergies !== 'None' ? `<div class="allergy-warning">‚ö†Ô∏è <strong>Allergies:</strong> ${p.allergies}</div>` : ''}
            <div class="patient-actions" style="margin-top: 15px;">
                <button class="btn btn-edit" onclick="editPatient(${p.id})">Edit</button>
                <button class="btn btn-danger" onclick="deletePatient(${p.id})">Delete</button>
            </div>
        </div>
    `).join('');
}
function searchPatients() {
    const searchTerm = document.getElementById('patientSearch').value.toLowerCase();
    const list = document.getElementById('patientList');
    const empty = document.getElementById('emptyState');
    
    const filteredPatients = data.patients.filter(p => {
        const fullName = `${p.firstName} ${p.lastName}`.toLowerCase();
        const studentNumber = (p.studentNumber || '').toLowerCase();
        return fullName.includes(searchTerm) || studentNumber.includes(searchTerm);
    });
    
    document.getElementById('patientCount').textContent = filteredPatients.length;
    
    if (filteredPatients.length === 0) {
        list.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }
    
    empty.classList.add('hidden');
    
    list.innerHTML = filteredPatients.map(p => `
        <div class="patient-card">
            <div class="patient-name">${p.firstName} ${p.lastName}</div>
            <div class="patient-id">ID: ${p.id} | Student #: ${p.studentNumber || 'N/A'}</div>
            <div class="patient-details">
                <div class="detail-item"><span class="detail-icon">üìÖ</span><span>${p.dateOfBirth}</span></div>
                <div class="detail-item"><span class="detail-icon">üë§</span><span>${p.gender}</span></div>
                <div class="detail-item"><span class="detail-icon">ü©∏</span><span>${p.bloodType}</span></div>
                <div class="detail-item"><span class="detail-icon">üìû</span><span>${p.phone}</span></div>
                <div class="detail-item"><span class="detail-icon">‚úâÔ∏è</span><span>${p.email}</span></div>
                <div class="detail-item"><span class="detail-icon">üìç</span><span>${p.address}</span></div>
            </div>
            ${p.allergies && p.allergies !== 'None' ? `<div class="allergy-warning">‚ö†Ô∏è <strong>Allergies:</strong> ${p.allergies}</div>` : ''}
            <div class="patient-actions" style="margin-top: 15px;">
                <button class="btn btn-edit" onclick="editPatient(${p.id})">Edit</button>
                <button class="btn btn-danger" onclick="deletePatient(${p.id})">Delete</button>
            </div>
        </div>
    `).join('');
}

    function clearPatientForm() {
        ['firstName','lastName','patientType','dateOfBirth','gender','bloodType','phone','email','address','allergies','emergencyContact'].forEach(id => {
            document.getElementById(id).value = '';
        });
        document.getElementById('formTitle').textContent = 'üìã Register New Patient';
    }

    function initializeNewPatientForm() {
        ['firstName','lastName','patientType','dateOfBirth','gender','bloodType','phone','email','address','allergies','emergencyContact'].forEach(id => {
            document.getElementById(id).value = '';
        });
        
        ['patientType','gender','bloodType'].forEach(id => {
            const select = document.getElementById(id);
            select.selectedIndex = 0;
        });
        
        document.getElementById('formTitle').textContent = 'üìã Register New Patient';
        editing.patient = null;
    }

    async function savePatient() {
    const p = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        studentNumber: document.getElementById('studentNumber')?.value.trim() || '',
        middleInitial: document.getElementById('middleInitial')?.value.trim() || '',
        suffix: document.getElementById('suffix')?.value.trim() || '',
        patientType: document.getElementById('patientType')?.value || 'Student', 
        dateOfBirth: document.getElementById('dateOfBirth').value,
        gender: document.getElementById('gender').value,
        bloodType: document.getElementById('bloodType').value,
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim(),
        address: document.getElementById('address').value.trim(),
        allergies: document.getElementById('allergies').value.trim() || 'None',
        emergencyContact: document.getElementById('emergencyContact').value.trim()
    };
    
    if (!p.firstName || !p.lastName || !p.dateOfBirth || !p.gender || !p.bloodType || !p.phone || !p.email || !p.address || !p.emergencyContact) {
        alert('Please fill all required fields');
        return;
    }
    
    if (editing.patient) {
        // Updating existing patient
        p.id = editing.patient;
        await updateInStore('patients', p);
        alert('Patient updated!');
    } else {
        // Creating new patient
        if (!p.studentNumber) {
            alert('Student Number is required to create login credentials');
            return;
        }
        
        // Check if student number already exists
        const existingPatient = data.patients.find(patient => patient.studentNumber === p.studentNumber);
        if (existingPatient) {
            alert('Student Number already exists!');
            return;
        }
        
        // Save patient first and get the auto-generated ID
        const patientId = await addToStore('patients', p);
        
        // Reload patients to get the complete patient object with ID
        data.patients = await getAllFromStore('patients');
        
        // Find the newly created patient
        const newPatient = data.patients.find(patient => patient.id === patientId);
        
        // Automatically create user account
        const defaultPassword = 'cdm' + p.studentNumber;
        
        const newUser = {
            fullName: `${p.firstName} ${p.lastName}`,
            username: p.studentNumber,
            password: defaultPassword,
            patientId: patientId,  // This links to the patient
            createdDate: new Date().toLocaleDateString()
        };
        
        await addToStore('users', newUser);
        data.users = await getAllFromStore('users');
        
        alert(`Patient registered!\n\nLogin credentials created:\nUsername: ${p.studentNumber}\nPassword: ${defaultPassword}\n\nPlease share these credentials with the student.`);
    }
    
    data.patients = await getAllFromStore('patients');
    editing.patient = null;
    showView('list');
}

function clearFormAndShow() {
    editing.patient = null;
    document.getElementById('formTitle').textContent = 'üìã Register New Patient';
    
    // Clear ALL fields
    document.getElementById('studentNumber').value = '';
    document.getElementById('firstName').value = '';
    document.getElementById('lastName').value = '';
    document.getElementById('middleInitial').value = '';
    document.getElementById('suffix').value = '';
    document.getElementById('dateOfBirth').value = '';
    document.getElementById('gender').value = '';
    document.getElementById('bloodType').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('email').value = '';
    document.getElementById('address').value = '';
    document.getElementById('allergies').value = '';
    document.getElementById('emergencyContact').value = '';
    
    showView('register');
}

    function editPatient(id) {
    const p = data.patients.find(x => x.id === id);
    if (!p) return;
    
    // Set editing mode FIRST
    editing.patient = id;
    
    // Change title and show form
    document.getElementById('formTitle').textContent = '‚úèÔ∏è Update Patient';
    showView('register');
    
    // Use setTimeout to ensure form is visible before filling
    setTimeout(() => {
        document.getElementById('studentNumber').value = p.studentNumber || '';
        document.getElementById('firstName').value = p.firstName || '';
        document.getElementById('lastName').value = p.lastName || '';
        document.getElementById('middleInitial').value = p.middleInitial || '';
        document.getElementById('suffix').value = p.suffix || '';
        document.getElementById('dateOfBirth').value = p.dateOfBirth || '';
        document.getElementById('gender').value = p.gender || '';
        document.getElementById('bloodType').value = p.bloodType || '';
        document.getElementById('phone').value = p.phone || '';
        document.getElementById('email').value = p.email || '';
        document.getElementById('address').value = p.address || '';
        document.getElementById('allergies').value = p.allergies === 'None' ? '' : (p.allergies || '');
        document.getElementById('emergencyContact').value = p.emergencyContact || '';
    }, 0);
}

    async function deletePatient(id) {
    if (!confirm('Delete this patient? This will also delete their user account if they have one.')) return;
    
    // Find if there's a user linked to this patient
    const linkedUser = data.users.find(u => u.patientId === id);
    
    // Delete the user account if it exists
    if (linkedUser) {
        await deleteFromStore('users', linkedUser.id);
        data.users = await getAllFromStore('users');
    }
    
    // Delete the patient
    await deleteFromStore('patients', id);
    data.patients = await getAllFromStore('patients');
    
    alert('Patient and associated user account deleted successfully!');
    renderPatients();
}

    function showScheduleForm() {
        document.getElementById('scheduleView').classList.add('hidden');
        document.getElementById('scheduleFormView').classList.remove('hidden');
        document.getElementById('nurseName').value = '';
        document.getElementById('scheduleDay').value = '';
        document.getElementById('scheduleTime').value = '';
        editing.schedule = null;
    }

    function renderSchedules() {
    const list = document.getElementById('scheduleList');
    list.innerHTML = data.schedules.map(s => {
        const statusClass = s.status === 'Available' ? 'available' : 
                           s.status === 'On Break' ? 'break' : 'leave';
        const statusDisplay = s.status === 'Available' ? 'status-available' : 
                             s.status === 'On Break' ? 'status-break' : 'status-leave';
        
        return `
        <div class="schedule-card">
            <h3>${s.day}</h3>
            <p><strong>${s.nurse}</strong></p>
            <p>üïê ${s.time}</p>
            <div>
                <span class="nurse-status ${statusDisplay}">
                    ${s.status === 'Available' ? '‚úì' : s.status === 'On Break' ? '‚òï' : 'üö´'} 
                    ${s.status || 'Available'}
                </span>
            </div>
            ${currentUser && currentUser.type === 'admin' ? `
            <div class="status-controls">
                <button class="status-btn available" onclick="updateNurseStatus(${s.id}, 'Available')">Available</button>
                <button class="status-btn break" onclick="updateNurseStatus(${s.id}, 'On Break')">On Break</button>
                <button class="status-btn leave" onclick="updateNurseStatus(${s.id}, 'On Leave')">On Leave</button>
            </div>
            <div class="item-actions" style="margin-top:15px;">
                <button class="btn btn-secondary" onclick="deleteSchedule(${s.id})">Delete</button>
            </div>
            ` : ''}
        </div>
    `}).join('');
}

    async function saveSchedule() {
    const s = {
        nurse: document.getElementById('nurseName').value.trim(),
        day: document.getElementById('scheduleDay').value,
        time: document.getElementById('scheduleTime').value.trim(),
        status: 'Available' // Default status for new schedules
    };
    if (!s.nurse || !s.day || !s.time) {
        alert('Please fill all fields');
        return;
    }
    await addToStore('schedules', s);
    data.schedules = await getAllFromStore('schedules');
    alert('Schedule added!');
    showView('schedule');
}

    async function deleteSchedule(id) {
        if (!confirm('Delete schedule?')) return;
        await deleteFromStore('schedules', id);
        data.schedules = await getAllFromStore('schedules');
        renderSchedules();
    }
    async function updateNurseStatus(id, status) {
    const schedule = data.schedules.find(s => s.id === id);
    if (!schedule) return;
    
    schedule.status = status;
    await updateInStore('schedules', schedule);
    data.schedules = await getAllFromStore('schedules');
    renderSchedules();
    
    const statusEmoji = status === 'Available' ? '‚úì' : status === 'On Break' ? '‚òï' : 'üö´';
    alert(`${statusEmoji} Status updated to: ${status}`);
}

    function showInventoryForm() {
        document.getElementById('inventoryView').classList.add('hidden');
        document.getElementById('inventoryFormView').classList.remove('hidden');
        document.getElementById('medName').value = '';
        document.getElementById('medQuantity').value = '';
        document.getElementById('medUnit').value = '';
        document.getElementById('medExpiry').value = '';
        editing.medication = null;
    }

    function renderInventory() {
    const list = document.getElementById('inventoryList');
    list.innerHTML = data.medications.map(m => {
        const low = m.quantity < 20;
        return `
        <div class="inventory-item ${low ? 'low-stock' : ''}">
            <div class="inventory-info">
                ${low ? '<span class="low-stock-badge">LOW STOCK</span>' : ''}
                <div class="inventory-name">${m.name}</div>
                <div class="inventory-details">Expires: ${m.expiry}</div>
                ${currentUser && currentUser.type === 'admin' ? `
                <div class="quantity-controls">
                    <button class="quantity-btn" onclick="updateQuantity(${m.id}, -1)">-</button>
                    <span class="quantity-display">${m.quantity} ${m.unit}</span>
                    <button class="quantity-btn" onclick="updateQuantity(${m.id}, 1)">+</button>
                </div>
                ` : `
                <div style="margin-top: 10px;">Quantity: ${m.quantity} ${m.unit}</div>
                `}
            </div>
            ${currentUser && currentUser.type === 'admin' ? `
            <div class="item-actions">
                <button class="btn btn-danger" onclick="deleteMedication(${m.id})">Delete</button>
            </div>
            ` : ''}
        </div>`;
    }).join('');
}
async function updateQuantity(id, change) {
    const med = data.medications.find(m => m.id === id);
    if (!med) return;
    
    med.quantity = Math.max(0, med.quantity + change);
    await updateInStore('medications', med);
    data.medications = await getAllFromStore('medications');
    renderInventory();
}

    async function saveMedication() {
        const m = {
            name: document.getElementById('medName').value.trim(),
            quantity: parseInt(document.getElementById('medQuantity').value),
            unit: document.getElementById('medUnit').value.trim(),
            expiry: document.getElementById('medExpiry').value
        };

        if (!m.name || !m.quantity || !m.unit || !m.expiry) {
            alert('Please fill all fields');
            return;
        }

        await addToStore('medications', m);
        data.medications = await getAllFromStore('medications');
        alert('Medication added!');
        showView('inventory');
    }

    async function deleteMedication(id) {
        if (!confirm('Delete this medication?')) return;
        await deleteFromStore('medications', id);
        data.medications = await getAllFromStore('medications');
        renderInventory();
    }

    function showServiceForm() {
        document.getElementById('servicesView').classList.add('hidden');
        document.getElementById('serviceFormView').classList.remove('hidden');
        document.getElementById('serviceName').value = '';
        document.getElementById('serviceDescription').value = '';
        document.getElementById('serviceHours').value = '';
    }

    function renderServices() {
        const list = document.getElementById('servicesList');
        list.innerHTML = data.services.map(s => `
            <div class="service-card">
                <div class="service-name">${s.name}</div>
                <div class="service-description">${s.description}</div>
                <div class="service-hours">‚è∞ ${s.hours}</div>
            </div>
        `).join('');
    }

   function renderMyInfo() {
    const content = document.getElementById('myInfoContent');
    
    if (!currentUser || currentUser.type !== 'user' || !currentUser.patientData) {
        content.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p class="empty-message">No patient information found</p></div>';
        return;
    }
    
    const p = currentUser.patientData;
    
    // Get user's visit history
    const userVisits = data.visits.filter(v => v.patientId === p.id);
    userVisits.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
    
    content.innerHTML = `
        <div class="patient-card">
            <div class="patient-info">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div class="patient-name">${p.firstName} ${p.lastName}</div>
                    <button class="btn btn-primary" onclick="showView('changepassword')">üîí Change Password</button>
                </div>
                <div class="patient-id">Student Number: ${p.studentNumber || 'N/A'} | ID: ${p.id}</div>
                <div class="patient-details">
                    <div class="detail-item"><span class="detail-icon">üìÖ</span><span>Date of Birth: ${p.dateOfBirth}</span></div>
                    <div class="detail-item"><span class="detail-icon">üë§</span><span>Gender: ${p.gender}</span></div>
                    <div class="detail-item"><span class="detail-icon">ü©∏</span><span>Blood Type: ${p.bloodType}</span></div>
                    <div class="detail-item"><span class="detail-icon">üìû</span><span>Phone: ${p.phone}</span></div>
                    <div class="detail-item"><span class="detail-icon">‚úâÔ∏è</span><span>Email: ${p.email}</span></div>
                    <div class="detail-item"><span class="detail-icon">üìç</span><span>Address: ${p.address}</span></div>
                    <div class="detail-item"><span class="detail-icon">üö®</span><span>Emergency Contact: ${p.emergencyContact}</span></div>
                </div>
                ${p.allergies && p.allergies !== 'None' ? `<div class="allergy-warning">‚ö†Ô∏è <strong>Allergies:</strong> ${p.allergies}</div>` : ''}
            </div>
        </div>
        
        <div class="patient-card" style="margin-top: 20px;">
            <div class="visit-log-container" style="border-top: none; padding-top: 0;">
                <div class="visit-log-header">üìã My Visit History (${userVisits.length} total visits)</div>
                ${userVisits.length === 0 ? `
                    <div class="no-visits">No clinic visits recorded yet</div>
                ` : userVisits.map(v => {
                    const visitDate = new Date(v.dateTime);
                    const formattedDate = visitDate.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    const formattedTime = visitDate.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    return `
                        <div class="visit-entry ${v.type.toLowerCase().replace(' ', '-')}">
                            <div class="visit-entry-header">
                                <span class="visit-type-badge ${v.type.toLowerCase().replace(' ', '-')}">${v.type}</span>
                                <span class="visit-timestamp">${formattedDate} at ${formattedTime}</span>
                            </div>
                            <div class="visit-complaint">üè• ${v.complaint}</div>
                            <div class="visit-note">üìù ${v.notes}</div>
                            ${v.revisitDate ? `
                                <div class="scheduled-revisit">
                                    üîÑ Scheduled Revisit: ${new Date(v.revisitDate).toLocaleDateString()} 
                                    ${v.revisitReason ? `- ${v.revisitReason}` : ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

    async function saveService() {
        const s = {
            name: document.getElementById('serviceName').value.trim(),
            description: document.getElementById('serviceDescription').value.trim(),
            hours: document.getElementById('serviceHours').value.trim()
        };

        if (!s.name || !s.description || !s.hours) {
            alert('Please fill all fields');
            return;
        }

        await addToStore('services', s);
        data.services = await getAllFromStore('services');
        alert('Service added!');
        showView('services');
    }
    function showVisitForm() {
    document.getElementById('visitsView').classList.add('hidden');
    document.getElementById('visitFormView').classList.remove('hidden');
    
    // Populate patient dropdown
    const select = document.getElementById('visitPatientId');
    select.innerHTML = '<option value="">Select Patient</option>' + 
        data.patients.map(p => `<option value="${p.id}">${p.firstName} ${p.lastName} (${p.studentNumber})</option>`).join('');
    
    // Set default date to today
    document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('visitRevisit').value = '';
    document.getElementById('visitNotes').value = '';
}

function showVisitForm() {
    document.getElementById('visitsView').classList.add('hidden');
    document.getElementById('visitFormView').classList.remove('hidden');
    
    // Populate patient dropdown
    const select = document.getElementById('visitPatientId');
    select.innerHTML = '<option value="">Select Patient</option>' + 
        data.patients.map(p => `<option value="${p.id}">${p.firstName} ${p.lastName} - ${p.studentNumber || 'N/A'}</option>`).join('');
    
    // Set default date/time to now
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('visitDateTime').value = localDateTime;
    
    // Clear form
    document.getElementById('visitType').value = 'New Visit';
    document.getElementById('visitComplaint').value = '';
    document.getElementById('visitNotes').value = '';
    document.getElementById('visitRevisitDate').value = '';
    document.getElementById('visitRevisitReason').value = '';
}

function renderVisits() {
    const list = document.getElementById('visitsList');
    const filter = document.getElementById('visitPatientFilter');
    
    // Update filter dropdown
    filter.innerHTML = '<option value="">All Patients</option>' + 
        data.patients.map(p => `<option value="${p.id}">${p.firstName} ${p.lastName}</option>`).join('');
    
    if (data.visits.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><p class="empty-message">No visit records yet</p></div>';
        return;
    }
    
    // Group visits by patient
    const visitsByPatient = {};
    data.visits.forEach(visit => {
        if (!visitsByPatient[visit.patientId]) {
            visitsByPatient[visit.patientId] = [];
        }
        visitsByPatient[visit.patientId].push(visit);
    });
    
    // Sort visits within each patient by date (newest first)
    Object.keys(visitsByPatient).forEach(patientId => {
        visitsByPatient[patientId].sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
    });
    
    list.innerHTML = Object.keys(visitsByPatient).map(patientId => {
        const patient = data.patients.find(p => p.id === parseInt(patientId));
        if (!patient) return '';
        
        const visits = visitsByPatient[patientId];
        const totalVisits = visits.length;
        const lastVisit = visits[0];
        
        return `
            <div class="patient-card">
                <div class="patient-header">
                    <div class="patient-info" style="width: 100%;">
                        <div class="patient-name">${patient.firstName} ${patient.lastName}</div>
                        <div class="patient-id">Student #: ${patient.studentNumber || 'N/A'} | Total Visits: ${totalVisits}</div>
                        
                        <div class="visit-log-container">
                            <div class="visit-log-header">üìã Visit History</div>
                            ${visits.map(v => {
                                const visitDate = new Date(v.dateTime);
                                const formattedDate = visitDate.toLocaleDateString('en-US', { 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric' 
                                });
                                const formattedTime = visitDate.toLocaleTimeString('en-US', { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                                
                                return `
                                    <div class="visit-entry ${v.type.toLowerCase().replace(' ', '-')}">
                                        <div class="visit-entry-header">
                                            <span class="visit-type-badge ${v.type.toLowerCase().replace(' ', '-')}">${v.type}</span>
                                            <span class="visit-timestamp">${formattedDate} at ${formattedTime}</span>
                                        </div>
                                        <div class="visit-complaint">üè• ${v.complaint}</div>
                                        <div class="visit-note">üìù ${v.notes}</div>
                                        ${v.revisitDate ? `
                                            <div class="scheduled-revisit">
                                                üîÑ Scheduled Revisit: ${new Date(v.revisitDate).toLocaleDateString()} 
                                                ${v.revisitReason ? `- ${v.revisitReason}` : ''}
                                            </div>
                                        ` : ''}
                                        <div style="margin-top: 10px;">
                                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteVisit(${v.id})">Delete</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function filterVisitsByPatient() {
    const selectedPatientId = document.getElementById('visitPatientFilter').value;
    const list = document.getElementById('visitsList');
    
    if (!selectedPatientId) {
        renderVisits();
        return;
    }
    
    const patientVisits = data.visits.filter(v => v.patientId === parseInt(selectedPatientId));
    const patient = data.patients.find(p => p.id === parseInt(selectedPatientId));
    
    if (patientVisits.length === 0 || !patient) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><p class="empty-message">No visits found for this patient</p></div>';
        return;
    }
    
    // Sort by date (newest first)
    patientVisits.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
    
    list.innerHTML = `
        <div class="patient-card">
            <div class="patient-header">
                <div class="patient-info" style="width: 100%;">
                    <div class="patient-name">${patient.firstName} ${patient.lastName}</div>
                    <div class="patient-id">Student #: ${patient.studentNumber || 'N/A'} | Total Visits: ${patientVisits.length}</div>
                    
                    <div class="visit-log-container">
                        <div class="visit-log-header">üìã Visit History</div>
                        ${patientVisits.map(v => {
                            const visitDate = new Date(v.dateTime);
                            const formattedDate = visitDate.toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                            const formattedTime = visitDate.toLocaleTimeString('en-US', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                            
                            return `
                                <div class="visit-entry ${v.type.toLowerCase().replace(' ', '-')}">
                                    <div class="visit-entry-header">
                                        <span class="visit-type-badge ${v.type.toLowerCase().replace(' ', '-')}">${v.type}</span>
                                        <span class="visit-timestamp">${formattedDate} at ${formattedTime}</span>
                                    </div>
                                    <div class="visit-complaint">üè• ${v.complaint}</div>
                                    <div class="visit-note">üìù ${v.notes}</div>
                                    ${v.revisitDate ? `
                                        <div class="scheduled-revisit">
                                            üîÑ Scheduled Revisit: ${new Date(v.revisitDate).toLocaleDateString()} 
                                            ${v.revisitReason ? `- ${v.revisitReason}` : ''}
                                        </div>
                                    ` : ''}
                                    <div style="margin-top: 10px;">
                                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteVisit(${v.id})">Delete</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
}

async function saveVisit() {
    const visit = {
        patientId: parseInt(document.getElementById('visitPatientId').value),
        type: document.getElementById('visitType').value,
        dateTime: document.getElementById('visitDateTime').value,
        complaint: document.getElementById('visitComplaint').value.trim(),
        notes: document.getElementById('visitNotes').value.trim(),
        revisitDate: document.getElementById('visitRevisitDate').value || null,
        revisitReason: document.getElementById('visitRevisitReason').value.trim() || null
    };
    
    if (!visit.patientId || !visit.type || !visit.dateTime || !visit.complaint || !visit.notes) {
        alert('Please fill all required fields');
        return;
    }
    
    try {
        await addToStore('visits', visit);
        data.visits = await getAllFromStore('visits');
        alert('Visit record saved successfully!');
        showView('visits');
    } catch (error) {
        console.error('Error saving visit:', error);
        alert('Error saving visit record. Please try again.');
    }
}

async function deleteVisit(id) {
    if (!confirm('Delete this visit record?')) return;
    
    try {
        await deleteFromStore('visits', id);
        data.visits = await getAllFromStore('visits');
        renderVisits();
        alert('Visit record deleted successfully!');
    } catch (error) {
        console.error('Error deleting visit:', error);
        alert('Error deleting visit record. Please try again.');
    }
}
    // User Management Functions


function renderUsers() {
    const list = document.getElementById('usersList');
    if (data.users.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">üë§</div><p class="empty-message">No user accounts created</p></div>';
        return;
    }
    
    list.innerHTML = data.users.map(u => {
        const patient = data.patients.find(p => p.id === u.patientId);
        const patientName = patient ? `${patient.firstName} ${patient.lastName}` : 'Unknown';
        
        return `
            <div class="patient-card">
                <div class="patient-header">
                    <div class="patient-info">
                        <div class="patient-name">${u.fullName}</div>
                        <div class="patient-id">Username: ${u.username}</div>
                        <div class="patient-details">
                            <div class="detail-item"><span class="detail-icon">üë§</span><span>Linked Patient: ${patientName}</span></div>
                            <div class="detail-item"><span class="detail-icon">üìÖ</span><span>Created: ${u.createdDate || 'N/A'}</span></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}




    // Login System
let isAdminLogin = false;
let currentUser = null;

function toggleLoginType() {
    isAdminLogin = !isAdminLogin;
    const label = document.getElementById('loginTypeLabel');
    const toggleText = document.getElementById('toggleText');
    
    if (isAdminLogin) {
        label.textContent = 'Admin Login';
        toggleText.textContent = 'Switch to User Login';
    } else {
        label.textContent = 'User Login';
        toggleText.textContent = 'Switch to Admin Login';
    }
}

async function handleLogin() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    
    if (!username || !password) {
        alert('Please enter username and password');
        return;
    }
    
    if (isAdminLogin) {
        // Admin login
        if (username === 'admin' && password === 'admin123') {
            currentUser = { type: 'admin', name: 'Administrator' };
            loginSuccess();
        } else {
            alert('Invalid admin credentials');
        }
    } else {
        // User login - check against database
        const user = data.users.find(u => u.username === username && u.password === password);
        
        if (user) {
            const patient = data.patients.find(p => p.id === user.patientId);
            currentUser = { 
                type: 'user', 
                name: user.fullName,
                patientId: user.patientId,
                patientData: patient
            };
            loginSuccess();
        } else {
            alert('Invalid username or password');
        }
    }
}

function loginSuccess() {
    document.getElementById('loginView').style.display = 'none';
    document.querySelector('.container').style.display = 'block';
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('currentUserName').textContent = currentUser.name;
    
    // Show/hide admin elements
    const adminElements = document.querySelectorAll('.admin-only');
    
    if (currentUser.type === 'admin') {
        document.getElementById('patientsBtn').style.display = 'inline-block';
        document.getElementById('userMgmtBtn').style.display = 'inline-block';
        document.getElementById('myInfoBtn').style.display = 'none';
        // In the admin section, add:
document.getElementById('visitsBtn').style.display = 'inline-block';
        adminElements.forEach(el => el.style.display = 'inline-block');
        
        showView('list');
    } else {
        document.getElementById('patientsBtn').style.display = 'none';
        document.getElementById('userMgmtBtn').style.display = 'none';
        // In the user section, add:
document.getElementById('visitsBtn').style.display = 'none';
        document.getElementById('myInfoBtn').style.display = 'inline-block';
        adminElements.forEach(el => el.style.display = 'none');
        showView('myinfo');
    }
}

function logout() {
    currentUser = null;
    document.getElementById('loginView').style.display = 'block';
    document.querySelector('.container').style.display = 'none';
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
}
async function saveNewPassword() {
    const currentPassword = document.getElementById('currentPassword').value.trim();
    const newPassword = document.getElementById('newPassword').value.trim();
    const confirmPassword = document.getElementById('confirmPassword').value.trim();
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        alert('Please fill all fields');
        return;
    }
    
    // Find current user in database
    const user = data.users.find(u => u.patientId === currentUser.patientId);
    
    if (!user) {
        alert('User account not found');
        return;
    }
    
    // Verify current password
    if (user.password !== currentPassword) {
        alert('Current password is incorrect');
        return;
    }
    
    // Check if new passwords match
    if (newPassword !== confirmPassword) {
        alert('New passwords do not match');
        return;
    }
    
    // Check if new password is different from current
    if (newPassword === currentPassword) {
        alert('New password must be different from current password');
        return;
    }
    
    // Validate password length
    if (newPassword.length < 6) {
        alert('New password must be at least 6 characters long');
        return;
    }
    
    try {
        // Update password
        user.password = newPassword;
        await updateInStore('users', user);
        data.users = await getAllFromStore('users');
        
        alert('‚úÖ Password changed successfully!');
        showView('myinfo');
    } catch (error) {
        console.error('Error updating password:', error);
        alert('Error changing password. Please try again.');
    }
}

// Hide main container on initial load
document.querySelector('.container').style.display = 'none';

    // Initialize the app
    init();
</script>
</body>
</html>